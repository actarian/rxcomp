/**
 * @license rxcomp v1.0.0-beta.5
 * (c) 2020 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
import{BehaviorSubject,Subject,fromEvent}from"rxjs";import{takeUntil,tap,shareReplay}from"rxjs/operators";class Factory{constructor(...e){}}class Directive extends Factory{}class Component extends Factory{}const RESERVED_PROPERTIES=["constructor","rxcompId","onInit","onChanges","onDestroy","pushChanges","changes$","unsubscribe$"];class Context extends Component{constructor(e,t={}){super(),t=Context.mergeDescriptors(e,e,t),t=Context.mergeDescriptors(Object.getPrototypeOf(e),e,t),Object.defineProperties(this,t)}static mergeDescriptors(e,t,n={}){const s=Object.getOwnPropertyNames(e);for(;s.length;){let o=s.shift();if(-1===RESERVED_PROPERTIES.indexOf(o)&&!n.hasOwnProperty(o)){const s=Object.getOwnPropertyDescriptor(e,o);"function"==typeof s.value&&(s.value=(...e)=>t[o].apply(t,e)),n[o]=s}}return n}}class Structure extends Factory{}let ID=0;const CONTEXTS={},NODES={};class Module{compile(e,t){let n;return Module.querySelectorsAll(e,this.meta.selectors,[]).map(e=>{n&&n!==e.node&&(t=void 0);const s=this.makeInstance(e.node,e.factory,e.selector,t);return e.factory.prototype instanceof Component&&(n=e.node),s}).filter(e=>e)}makeInstance(e,t,n,s,o){if(s||e.parentNode){const r=t.prototype instanceof Component,i=t.meta;if(!(s=s||this.getParentInstance(e.parentNode)))return;const c=new t(...o||[]),a=Module.makeContext(this,c,s,e,t,n);let u;Object.defineProperties(c,{changes$:{value:new BehaviorSubject(c),writable:!1,enumerable:!1},unsubscribe$:{value:new Subject,writable:!1,enumerable:!1}});const l=this;return c.pushChanges=function(){this.changes$.next(this),r&&(u?l.parse(e,c):setTimeout((function(){l.parse(e,c)}))),c.onView&&c.onView()},i&&(this.makeHosts(i,c,e),a.inputs=this.makeInputs(i,c),a.outputs=this.makeOutputs(i,c)),c.onInit&&c.onInit(),u=!0,s instanceof Factory&&s.changes$&&s.changes$.pipe(takeUntil(c.unsubscribe$)).subscribe(e=>{i&&this.resolveInputsOutputs(c,e),c.onChanges&&c.onChanges(e),c.pushChanges()}),c}}makeContext(e,t,n,s){return Module.makeContext(this,e,t,n,e.constructor,s)}makeFunction(e,t=["$instance"]){if(e){e=Module.parseExpression(e);const n=t.join(",");return new Function(`with(this) {\n\t\t\t\treturn (function (${n}, $$module) {\n\t\t\t\t\tconst $$pipes = $$module.meta.pipes;\n\t\t\t\t\treturn ${e};\n\t\t\t\t}.bind(this)).apply(this, arguments);\n\t\t\t}`)}return()=>null}getInstance(e){if(e instanceof Document)return window;const t=getContextByNode(e);return t?t.instance:void 0}getParentInstance(e){return Module.traverseUp(e,e=>this.getInstance(e))}parse(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType){const e=s;getContextByNode(e)||this.parse(e,t)}else if(3===s.nodeType){const e=s;this.parseTextNode(e,t)}}}parseTextNode(e,t){let n=e.nodeExpressions;n||(n=this.parseTextNodeExpression(e.nodeValue));const s=n.reduce((e,n)=>{let s;return"function"==typeof n?(s=this.resolve(n,t,t),null==s&&(s="")):s=n,e+s},"");if(e.nodeValue!==s){const t=document.createTextNode(s);t.nodeExpressions=n,e.parentNode.replaceChild(t,e)}}pushFragment(e,t,n,s){const o=e.substring(t,n);s.push(o)}parseTextNodeExpression(e){const t=[],n=/\{{2}((([^{}])|(\{([^{}]|(\{.*?\}))+?\}))*?)\}{2}/g;let s,o=0;for(;null!==(s=n.exec(e));){const r=n.lastIndex-s[0].length;r>o&&this.pushFragment(e,r,o,t),o=n.lastIndex;const i=this.makeFunction(s[1]);t.push(i)}const r=e.length;return r>o&&this.pushFragment(e,o,r,t),t}resolve(e,t,n){return e.apply(t,[n,this])}makeHosts(e,t,n){e.hosts&&Object.keys(e.hosts).forEach(s=>{const o=e.hosts[s];t[s]=getHost(t,o,n)})}makeInput(e,t){const{node:n}=getContext(e);let s,o=null;if(n.hasAttribute(t)){o=`"${n.getAttribute(t).replace(/({{)|(}})|(")/g,(function(e,t,n,s){return t?'"+':n?'+"':s?'"':void 0}))}"`}else n.hasAttribute(`[${t}]`)&&(o=n.getAttribute(`[${t}]`));return null!==o&&(s=this.makeFunction(o)),s}makeInputs(e,t){const n={};return e.inputs&&e.inputs.forEach((e,s)=>{const o=this.makeInput(t,e);o&&(n[e]=o)}),n}makeOutput(e,t){const n=getContext(e),s=n.node,o=n.parentInstance,r=s.getAttribute(`(${t})`),i=this.makeFunction(r,["$event"]),c=(new Subject).pipe(tap(e=>{this.resolve(i,o,e)}));return c.pipe(takeUntil(e.unsubscribe$)).subscribe(),e[t]=c,i}makeOutputs(e,t){const n={};return e.outputs&&e.outputs.forEach((e,s)=>n[e]=this.makeOutput(t,e)),n}resolveInputsOutputs(e,t){const n=getContext(e),s=n.parentInstance,o=n.inputs;for(let t in o){const n=o[t],r=this.resolve(n,s,e);e[t]=r}}destroy(){this.remove(this.meta.node),this.meta.node.innerHTML=this.meta.nodeInnerHTML}remove(e,t){const n=t?getContext(t):void 0;return Module.traverseDown(e,e=>{const t=e.rxcompId;if(t){0===Module.deleteContext(t,n).length&&delete e.rxcompId}}),e}static parseExpression(e){const t=/(\()([^\(\)]*)(\))/;for(;e.match(t);)e=e.replace(t,(function(...e){return`┌${Module.parsePipes(e[2])}┘`}));return e=(e=Module.parsePipes(e)).replace(/(┌)|(┘)/g,(function(...e){return e[1]?"(":")"})),Module.parseOptionalChaining(e)}static parsePipes(e){const t=/(.*?[^\|])\|([^\|]+)/;for(;e.match(t);)e=e.replace(t,(function(e,...t){const n=t[0].trim(),s=Module.parsePipeParams(t[1]);return`$$pipes.${s.shift().trim()}.transform┌${[n,...s]}┘`}));return e}static parsePipeParams(e){const t=[];let n=0,s="",o=0;const r=e.length;for(;n<r;){const r=e.substr(n,1);"{"!==r&&"("!==r&&"["!==r||o++,"}"!==r&&")"!==r&&"]"!==r||o--,":"===r&&0===o?(s.length&&t.push(s.trim()),s=""):s+=r,n++}return s.length&&t.push(s.trim()),t}static parseOptionalChaining(e){let t;return e=e.replace(/(\w+(\?\.))+([\.|\w]+)/g,(function(e,...n){const s=e.split("?.");for(let e=0;e<s.length-1;e++){const n=e>0?`(${s[e]} = ${t})`:s[e],o=s[e+1];t=e>0?`${n}.${o}`:`(${n} ? ${n}.${o} : void 0)`}return t||""}))}static makeContext(e,t,n,s,o,r){t.rxcompId=++ID;const i={module:e,instance:t,parentInstance:n,node:s,factory:o,selector:r},c=s.rxcompId=s.rxcompId||t.rxcompId;return(NODES[c]||(NODES[c]=[])).push(i),CONTEXTS[t.rxcompId]=i,i}static deleteContext(e,t){const n=[],s=NODES[e];return s&&(s.forEach(e=>{if(e===t)n.push(t);else{const t=e.instance;t.unsubscribe$.next(),t.unsubscribe$.complete(),t.onDestroy&&(t.onDestroy(),delete CONTEXTS[t.rxcompId])}}),n.length?NODES[e]=n:delete NODES[e]),n}static matchSelectors(e,t,n){for(let s=0;s<t.length;s++){const o=t[s](e);if(o){const t=o.factory;if(t.prototype instanceof Component&&t.meta.template&&(e.innerHTML=t.meta.template),n.push(o),t.prototype instanceof Structure)break}}return n}static querySelectorsAll(e,t,n){if(1===e.nodeType){const s=this.matchSelectors(e,t,[]);if(n=n.concat(s),s.find(e=>e.factory.prototype instanceof Structure))return n;const o=e.childNodes;for(let e=0;e<o.length;e++)n=this.querySelectorsAll(o[e],t,n)}return n}static traverseUp(e,t,n=0){if(!e)return;const s=t(e,n);return s||this.traverseUp(e.parentNode,t,n+1)}static traverseDown(e,t,n=0){if(!e)return;let s=t(e,n);if(s)return s;if(1===e.nodeType){let o=0,r=e.childNodes.length;for(;o<r&&!s;)s=this.traverseDown(e.childNodes[o],t,n+1),o++}return s}static traversePrevious(e,t,n=0){if(!e)return;const s=t(e,n);return s||this.traversePrevious(e.previousSibling,t,n+1)}static traverseNext(e,t,n=0){if(!e)return;const s=t(e,n);return s||this.traverseNext(e.nextSibling,t,n+1)}}function getContext(e){return CONTEXTS[e.rxcompId]}function getContextByNode(e){let t;const n=e.rxcompId;if(n){const e=NODES[n];e&&(t=e.reduce((e,t)=>t.factory.prototype instanceof Component?t:t.factory.prototype instanceof Context?e||t:e,null))}return t}function getHost(e,t,n){if(n||(n=getContext(e).node),n.rxcompId){const t=NODES[n.rxcompId];if(t)for(let n=0;n<t.length;n++){const s=t[n];if(s.instance!==e&&s.instance instanceof Factory)return s.instance}}if(n.parentNode)return getHost(e,t,n.parentNode)}class ClassDirective extends Directive{onInit(){const{module:e,node:t}=getContext(this),n=t.getAttribute("[class]");this.classFunction=e.makeFunction(n)}onChanges(e){const{module:t,node:n}=getContext(this),s=t.resolve(this.classFunction,e,this);for(let e in s)s[e]?n.classList.add(e):n.classList.remove(e)}}ClassDirective.meta={selector:"[[class]]"};const EVENTS=["mousedown","mouseup","mousemove","click","dblclick","mouseover","mouseout","mouseenter","mouseleave","contextmenu","touchstart","touchmove","touchend","keydown","keyup","input","change","loaded"];class EventDirective extends Directive{onInit(){const{module:e,node:t,parentInstance:n,selector:s}=getContext(this),o=this.event=s.replace(/\[|\]|\(|\)/g,""),r=this.event$=fromEvent(t,o).pipe(shareReplay(1)),i=t.getAttribute(`(${o})`);if(i){const t=e.makeFunction(i,["$event"]);r.pipe(takeUntil(this.unsubscribe$)).subscribe(s=>{e.resolve(t,n,s)})}else n[`${o}$`]=r}}EventDirective.meta={selector:`[(${EVENTS.join(")],[(")})]`};class ForItem extends Context{constructor(e,t,n,s,o,r,i){super(i),this[e]=t,this[n]=s,this.index=o,this.count=r}get first(){return 0===this.index}get last(){return this.index===this.count-1}get even(){return this.index%2==0}get odd(){return!this.even}}class ForStructure extends Structure{constructor(){super(...arguments),this.instances=[]}onInit(){const{module:e,node:t}=getContext(this),n=this.forbegin=document.createComment("*for begin");n.rxcompId=t.rxcompId,t.parentNode.replaceChild(n,t);const s=this.forend=document.createComment("*for end");n.parentNode.insertBefore(s,n.nextSibling);const o=t.getAttribute("*for");t.removeAttribute("*for");const r=this.token=this.getExpressionToken(o);this.forFunction=e.makeFunction(r.iterable)}onChanges(e){const t=getContext(this),n=t.module,s=t.node,o=this.token;let r=n.resolve(this.forFunction,e,this)||[];const i=Array.isArray(r),c=i?r:Object.keys(r),a=c.length,u=this.instances.length;for(let e=0;e<Math.max(u,a);e++)if(e<a){const l=i?e:c[e],p=i?c[l]:r[l];if(e<u){const t=this.instances[e];t[o.key]=l,t[o.value]=p}else{const r=s.cloneNode(!0);delete r.rxcompId,this.forend.parentNode.insertBefore(r,this.forend);const i=[o.key,l,o.value,p,e,a,t.parentInstance],c=n.makeInstance(r,ForItem,t.selector,t.parentInstance,i);if(c){const e=getContext(c);n.compile(r,e.instance),this.instances.push(c)}}}else{const t=this.instances[e],{node:s}=getContext(t);s.parentNode.removeChild(s),n.remove(s)}this.instances.length=c.length}getExpressionToken(e){if(null===e)throw"invalid for";if(-1===e.trim().indexOf("let ")||-1===e.trim().indexOf(" of "))throw"invalid for";const t=e.split(";").map(e=>e.trim()).filter(e=>""!==e),n=t[0].split(" of ").map(e=>e.trim());let s=n[0].replace(/\s*let\s*/,"");const o=n[1];let r="index";const i=s.match(/\[(.+)\s*,\s*(.+)\]/);if(i&&(r=i[1],s=i[2]),t.length>1){const e=t[1].split(/\s*let\s*|\s*=\s*index/).map(e=>e.trim());3===e.length&&(r=e[1])}return{key:r,value:s,iterable:o}}}ForStructure.meta={selector:"[*for]"};class HrefDirective extends Directive{onChanges(e){const{node:t}=getContext(this);t.setAttribute("href",this.href)}}HrefDirective.meta={selector:"[[href]]",inputs:["href"]};class IfStructure extends Structure{constructor(){super(...arguments),this.instances=[]}onInit(){const{module:e,node:t}=getContext(this),n=this.ifbegin=document.createComment("*if begin");n.rxcompId=t.rxcompId,t.parentNode.replaceChild(n,t);const s=this.ifend=document.createComment("*if end");n.parentNode.insertBefore(s,n.nextSibling);const o=t.getAttribute("*if");this.ifFunction=e.makeFunction(o);const r=t.cloneNode(!0);r.removeAttribute("*if"),this.clonedNode=r,this.node=r.cloneNode(!0)}onChanges(e){const{module:t}=getContext(this),n=t.resolve(this.ifFunction,e,this),s=this.node;n?s.parentNode||(this.ifend.parentNode.insertBefore(s,this.ifend),t.compile(s)):s.parentNode&&(t.remove(s,this),s.parentNode.removeChild(s),this.node=this.clonedNode.cloneNode(!0))}}IfStructure.meta={selector:"[*if]"};class InnerHtmlDirective extends Directive{onChanges(e){const{node:t}=getContext(this);t.innerHTML=null==this.innerHTML?"":this.innerHTML}}InnerHtmlDirective.meta={selector:"[innerHTML]",inputs:["innerHTML"]};class Pipe{static transform(e){return e}}class JsonPipe extends Pipe{static transform(e){return JSON.stringify(e,null,"\t")}}JsonPipe.meta={name:"json"};class SrcDirective extends Directive{onChanges(e){const{node:t}=getContext(this);t.setAttribute("src",this.src)}}SrcDirective.meta={selector:"[[src]]",inputs:["src"]};class StyleDirective extends Directive{onInit(){const{module:e,node:t}=getContext(this),n=t.getAttribute("[style]");this.styleFunction=e.makeFunction(n)}onChanges(e){const{module:t,node:n}=getContext(this),s=t.resolve(this.styleFunction,e,this);for(let e in s)n.style.setProperty(e,s[e])}}StyleDirective.meta={selector:"[[style]]"};class CoreModule extends Module{}const factories=[ClassDirective,EventDirective,ForStructure,HrefDirective,IfStructure,InnerHtmlDirective,SrcDirective,StyleDirective],pipes=[JsonPipe];CoreModule.meta={declarations:[...factories,...pipes],exports:[...factories,...pipes]};const ORDER=[Structure,Component,Directive];class Platform{static bootstrap(e){const t=this.resolveMeta(e);console.log(t);const n=t.bootstrap;if(!n)throw"missing bootstrap";const s=t.node=this.querySelector(n.meta.selector);if(!s)throw`missing node ${n.meta.selector}`;t.nodeInnerHTML=s.innerHTML;t.pipes=this.resolvePipes(t);const o=t.factories=this.resolveFactories(t);this.sortFactories(o),o.unshift(n);t.selectors=this.unwrapSelectors(o);const r=new e;return r.meta=t,r.compile(s,window)[0].pushChanges(),r}static querySelector(e){return document.querySelector(e)}static resolveMeta(e){const t=Object.assign({imports:[],declarations:[],pipes:[],exports:[]},e.meta);return t.imports=t.imports.map(e=>this.resolveMeta(e)),t}static resolvePipes(e,t){const n=e.imports.map(e=>this.resolvePipes(e,!0)),s={};return(t?e.exports:e.declarations).filter(e=>e.prototype instanceof Pipe).forEach(e=>s[e.meta.name]=e),Object.assign({},...n,s)}static resolveFactories(e,t){const n=e.imports.map(e=>this.resolveFactories(e,!0)),s=(t?e.exports:e.declarations).filter(e=>e.prototype instanceof Structure||e.prototype instanceof Component||e.prototype instanceof Directive);return Array.prototype.concat.call(s,...n)}static sortFactories(e){e.sort((e,t)=>{const n=ORDER.reduce((t,n,s)=>e.prototype instanceof n?s:t,-1)-ORDER.reduce((e,n,s)=>t.prototype instanceof n?s:e,-1);return 0===n?(e.meta.hosts?1:0)-(t.meta.hosts?1:0):n})}static getExpressions(e){let t=[];return e.replace(/\.([\w\-\_]+)|\[(.+?\]*)(\=)(.*?)\]|\[(.+?\]*)\]|([\w\-\_]+)/g,(function(e,n,s,o,r,i,c){return n&&t.push((function(e){return e.classList.contains(n)})),s&&t.push((function(e){return e.hasAttribute(s)&&e.getAttribute(s)===r||e.hasAttribute(`[${s}]`)&&e.getAttribute(`[${s}]`)===r})),i&&t.push((function(e){return e.hasAttribute(i)||e.hasAttribute(`[${i}]`)})),c&&t.push((function(e){return e.nodeName.toLowerCase()===c.toLowerCase()})),""})),t}static unwrapSelectors(e){const t=[];return e.forEach(e=>{e.meta.selector.split(",").forEach(n=>{n=n.trim();let s=[];const o=n.replace(/\:not\((.+?)\)/g,(e,t)=>(s=this.getExpressions(t),"")),r=this.getExpressions(o);t.push(t=>{const o=r.reduce((e,n)=>e&&n(t),!0),i=s.reduce((e,n)=>e||n(t),!1);return!(!o||i)&&{node:t,factory:e,selector:n}})})}),t}static isBrowser(){return Boolean(window)}}class Browser extends Platform{}export{Browser,ClassDirective,Component,Context,CoreModule,Directive,EventDirective,ForItem,ForStructure,HrefDirective,IfStructure,InnerHtmlDirective,JsonPipe,Module,Pipe,Platform,SrcDirective,Structure,StyleDirective,getContext,getContextByNode,getHost};