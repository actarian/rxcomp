/**
 * @license rxcomp v1.0.0-beta.5
 * (c) 2020 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
import{__extends,__spreadArrays}from"tslib";import{BehaviorSubject,Subject,fromEvent}from"rxjs";import{takeUntil,tap,shareReplay}from"rxjs/operators";var RxCompElement=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(HTMLElement),RxCompText=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Text),Factory=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},Directive=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Factory),Component=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Factory),RESERVED_PROPERTIES=["constructor","rxcompId","onInit","onChanges","onDestroy","pushChanges","changes$","unsubscribe$"],Context=function(t){function e(n,r){void 0===r&&(r={});var o=t.call(this)||this;return r=e.mergeDescriptors(n,n,r),r=e.mergeDescriptors(Object.getPrototypeOf(n),n,r),Object.defineProperties(o,r),o}return __extends(e,t),e.mergeDescriptors=function(t,e,n){void 0===n&&(n={});for(var r=Object.getOwnPropertyNames(t),o=function(){var o=r.shift();if(-1===RESERVED_PROPERTIES.indexOf(o)&&!n.hasOwnProperty(o)){var i=Object.getOwnPropertyDescriptor(t,o);"function"==typeof i.value&&(i.value=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e[o].apply(e,t)}),n[o]=i}};r.length;)o();return n},e}(Component),Structure=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Factory),ID=0,CONTEXTS={},NODES={},Module=function(){function t(){}return t.prototype.compile=function(e,n){var r,o=this;return t.querySelectorsAll(e,this.meta.selectors,[]).map((function(t){r&&r!==t.node&&(n=void 0);var e=o.makeInstance(t.node,t.factory,t.selector,n);return t.factory.prototype instanceof Component&&(r=t.node),e})).filter((function(t){return t}))},t.prototype.makeInstance=function(e,n,r,o,i){var s=this;if(o||e.parentNode){var u=n.prototype instanceof Component,a=n.meta;if(!(o=o||this.getParentInstance(e.parentNode)))return;var c,p=new(n.bind.apply(n,__spreadArrays([void 0],i||[]))),f=t.makeContext(this,p,o,e,n,r);Object.defineProperties(p,{changes$:{value:new BehaviorSubject(p),writable:!1,enumerable:!1},unsubscribe$:{value:new Subject,writable:!1,enumerable:!1}});var l=this;return p.pushChanges=function(){this.changes$.next(this),u&&(c?l.parse(e,p):setTimeout((function(){l.parse(e,p)}))),p.onView&&p.onView()},a&&(this.makeHosts(a,p,e),f.inputs=this.makeInputs(a,p),f.outputs=this.makeOutputs(a,p)),p.onInit&&p.onInit(),c=!0,o instanceof Factory&&o.changes$&&o.changes$.pipe(takeUntil(p.unsubscribe$)).subscribe((function(t){a&&s.resolveInputsOutputs(p,t),p.onChanges&&p.onChanges(t),p.pushChanges()})),p}},t.prototype.makeContext=function(e,n,r,o){return t.makeContext(this,e,n,r,e.constructor,o)},t.prototype.makeFunction=function(e,n){if(void 0===n&&(n=["$instance"]),e){e=t.parseExpression(e);var r=n.join(",");return new Function("with(this) {\n\t\t\t\treturn (function ("+r+", $$module) {\n\t\t\t\t\tconst $$pipes = $$module.meta.pipes;\n\t\t\t\t\treturn "+e+";\n\t\t\t\t}.bind(this)).apply(this, arguments);\n\t\t\t}")}return function(){return null}},t.prototype.getInstance=function(t){if(t instanceof Document)return window;var e=getContextByNode(t);return e?e.instance:void 0},t.prototype.getParentInstance=function(e){var n=this;return t.traverseUp(e,(function(t){return n.getInstance(t)}))},t.prototype.parse=function(t,e){for(var n=0;n<t.childNodes.length;n++){var r=t.childNodes[n];if(1===r.nodeType){var o=r;getContextByNode(o)||this.parse(o,e)}else if(3===r.nodeType){var i=r;this.parseTextNode(i,e)}}},t.prototype.parseTextNode=function(t,e){var n=this,r=t.nodeExpressions;r||(r=this.parseTextNodeExpression(t.nodeValue));var o=r.reduce((function(t,r){var o;return"function"==typeof r?null==(o=n.resolve(r,e,e))&&(o=""):o=r,t+o}),"");if(t.nodeValue!==o){var i=document.createTextNode(o);i.nodeExpressions=r,t.parentNode.replaceChild(i,t)}},t.prototype.pushFragment=function(t,e,n,r){var o=t.substring(e,n);r.push(o)},t.prototype.parseTextNodeExpression=function(t){for(var e,n=[],r=/\{{2}((([^{}])|(\{([^{}]|(\{.*?\}))+?\}))*?)\}{2}/g,o=0;null!==(e=r.exec(t));){var i=r.lastIndex-e[0].length;i>o&&this.pushFragment(t,i,o,n),o=r.lastIndex;var s=this.makeFunction(e[1]);n.push(s)}var u=t.length;return u>o&&this.pushFragment(t,o,u,n),n},t.prototype.resolve=function(t,e,n){return t.apply(e,[n,this])},t.prototype.makeHosts=function(t,e,n){t.hosts&&Object.keys(t.hosts).forEach((function(r){var o=t.hosts[r];e[r]=getHost(e,o,n)}))},t.prototype.makeInput=function(t,e){var n,r=getContext(t).node,o=null;r.hasAttribute(e)?o='"'+r.getAttribute(e).replace(/({{)|(}})|(")/g,(function(t,e,n,r){return e?'"+':n?'+"':r?'"':void 0}))+'"':r.hasAttribute("["+e+"]")&&(o=r.getAttribute("["+e+"]"));return null!==o&&(n=this.makeFunction(o)),n},t.prototype.makeInputs=function(t,e){var n=this,r={};return t.inputs&&t.inputs.forEach((function(t,o){var i=n.makeInput(e,t);i&&(r[t]=i)})),r},t.prototype.makeOutput=function(t,e){var n=this,r=getContext(t),o=r.node,i=r.parentInstance,s=o.getAttribute("("+e+")"),u=this.makeFunction(s,["$event"]),a=(new Subject).pipe(tap((function(t){n.resolve(u,i,t)})));return a.pipe(takeUntil(t.unsubscribe$)).subscribe(),t[e]=a,u},t.prototype.makeOutputs=function(t,e){var n=this,r={};return t.outputs&&t.outputs.forEach((function(t,o){return r[t]=n.makeOutput(e,t)})),r},t.prototype.resolveInputsOutputs=function(t,e){var n=getContext(t),r=n.parentInstance,o=n.inputs;for(var i in o){var s=o[i],u=this.resolve(s,r,t);t[i]=u}},t.prototype.destroy=function(){this.remove(this.meta.node),this.meta.node.innerHTML=this.meta.nodeInnerHTML},t.prototype.remove=function(e,n){var r=n?getContext(n):void 0;return t.traverseDown(e,(function(e){var n=e.rxcompId;n&&(0===t.deleteContext(n,r).length&&delete e.rxcompId)})),e},t.parseExpression=function(e){for(var n=/(\()([^\(\)]*)(\))/;e.match(n);)e=e.replace(n,(function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return"┌"+t.parsePipes(e[2])+"┘"}));return e=(e=t.parsePipes(e)).replace(/(┌)|(┘)/g,(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t[1]?"(":")"})),t.parseOptionalChaining(e)},t.parsePipes=function(e){for(var n=/(.*?[^\|])\|([^\|]+)/;e.match(n);)e=e.replace(n,(function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=n[0].trim(),i=t.parsePipeParams(n[1]),s=i.shift().trim();return"$$pipes."+s+".transform┌"+__spreadArrays([o],i)+"┘"}));return e},t.parsePipeParams=function(t){for(var e=[],n=0,r="",o=0,i=t.length;n<i;){var s=t.substr(n,1);"{"!==s&&"("!==s&&"["!==s||o++,"}"!==s&&")"!==s&&"]"!==s||o--,":"===s&&0===o?(r.length&&e.push(r.trim()),r=""):r+=s,n++}return r.length&&e.push(r.trim()),e},t.parseOptionalChaining=function(t){var e;return t=t.replace(/(\w+(\?\.))+([\.|\w]+)/g,(function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];for(var o=t.split("?."),i=0;i<o.length-1;i++){var s=i>0?"("+o[i]+" = "+e+")":o[i],u=o[i+1];e=i>0?s+"."+u:"("+s+" ? "+s+"."+u+" : void 0)"}return e||""}))},t.makeContext=function(t,e,n,r,o,i){e.rxcompId=++ID;var s={module:t,instance:e,parentInstance:n,node:r,factory:o,selector:i},u=r.rxcompId=r.rxcompId||e.rxcompId;return(NODES[u]||(NODES[u]=[])).push(s),CONTEXTS[e.rxcompId]=s,s},t.deleteContext=function(t,e){var n=[],r=NODES[t];return r&&(r.forEach((function(t){if(t===e)n.push(e);else{var r=t.instance;r.unsubscribe$.next(),r.unsubscribe$.complete(),r.onDestroy&&(r.onDestroy(),delete CONTEXTS[r.rxcompId])}})),n.length?NODES[t]=n:delete NODES[t]),n},t.matchSelectors=function(t,e,n){for(var r=0;r<e.length;r++){var o=e[r](t);if(o){var i=o.factory;if(i.prototype instanceof Component&&i.meta.template&&(t.innerHTML=i.meta.template),n.push(o),i.prototype instanceof Structure)break}}return n},t.querySelectorsAll=function(t,e,n){if(1===t.nodeType){var r=this.matchSelectors(t,e,[]);if(n=n.concat(r),r.find((function(t){return t.factory.prototype instanceof Structure})))return n;for(var o=t.childNodes,i=0;i<o.length;i++)n=this.querySelectorsAll(o[i],e,n)}return n},t.traverseUp=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);return r||this.traverseUp(t.parentNode,e,n+1)}},t.traverseDown=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);if(r)return r;if(1===t.nodeType)for(var o=0,i=t.childNodes.length;o<i&&!r;)r=this.traverseDown(t.childNodes[o],e,n+1),o++;return r}},t.traversePrevious=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);return r||this.traversePrevious(t.previousSibling,e,n+1)}},t.traverseNext=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);return r||this.traverseNext(t.nextSibling,e,n+1)}},t}();function getContext(t){return CONTEXTS[t.rxcompId]}function getContextByNode(t){var e,n=t.rxcompId;if(n){var r=NODES[n];r&&(e=r.reduce((function(t,e){return e.factory.prototype instanceof Component?e:e.factory.prototype instanceof Context?t||e:t}),null))}return e}function getHost(t,e,n){if(n||(n=getContext(t).node),n.rxcompId){var r=NODES[n.rxcompId];if(r)for(var o=0;o<r.length;o++){var i=r[o];if(i.instance!==t&&i.instance instanceof Factory)return i.instance}}if(n.parentNode)return getHost(t,e,n.parentNode)}var ClassDirective=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onInit=function(){var t=getContext(this),e=t.module,n=t.node.getAttribute("[class]");this.classFunction=e.makeFunction(n)},e.prototype.onChanges=function(t){var e=getContext(this),n=e.module,r=e.node,o=n.resolve(this.classFunction,t,this);for(var i in o)o[i]?r.classList.add(i):r.classList.remove(i)},e}(Directive);ClassDirective.meta={selector:"[[class]]"};var EVENTS=["mousedown","mouseup","mousemove","click","dblclick","mouseover","mouseout","mouseenter","mouseleave","contextmenu","touchstart","touchmove","touchend","keydown","keyup","input","change","loaded"],EventDirective=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onInit=function(){var t=getContext(this),e=t.module,n=t.node,r=t.parentInstance,o=t.selector,i=this.event=o.replace(/\[|\]|\(|\)/g,""),s=this.event$=fromEvent(n,i).pipe(shareReplay(1)),u=n.getAttribute("("+i+")");if(u){var a=e.makeFunction(u,["$event"]);s.pipe(takeUntil(this.unsubscribe$)).subscribe((function(t){e.resolve(a,r,t)}))}else r[i+"$"]=s},e}(Directive);EventDirective.meta={selector:"[("+EVENTS.join(")],[(")+")]"};var ForItem=function(t){function e(e,n,r,o,i,s,u){var a=t.call(this,u)||this;return a[e]=n,a[r]=o,a.index=i,a.count=s,a}return __extends(e,t),Object.defineProperty(e.prototype,"first",{get:function(){return 0===this.index},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"last",{get:function(){return this.index===this.count-1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"even",{get:function(){return this.index%2==0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"odd",{get:function(){return!this.even},enumerable:!0,configurable:!0}),e}(Context),ForStructure=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.instances=[],e}return __extends(e,t),e.prototype.onInit=function(){var t=getContext(this),e=t.module,n=t.node,r=this.forbegin=document.createComment("*for begin");r.rxcompId=n.rxcompId,n.parentNode.replaceChild(r,n);var o=this.forend=document.createComment("*for end");r.parentNode.insertBefore(o,r.nextSibling);var i=n.getAttribute("*for");n.removeAttribute("*for");var s=this.token=this.getExpressionToken(i);this.forFunction=e.makeFunction(s.iterable)},e.prototype.onChanges=function(t){for(var e=getContext(this),n=e.module,r=e.node,o=this.token,i=n.resolve(this.forFunction,t,this)||[],s=Array.isArray(i),u=s?i:Object.keys(i),a=u.length,c=this.instances.length,p=0;p<Math.max(c,a);p++)if(p<a){var f=s?p:u[p],l=s?u[f]:i[f];if(p<c){(m=this.instances[p])[o.key]=f,m[o.value]=l}else{var h=r.cloneNode(!0);delete h.rxcompId,this.forend.parentNode.insertBefore(h,this.forend);var v=[o.key,f,o.value,l,p,a,e.parentInstance];if(m=n.makeInstance(h,ForItem,e.selector,e.parentInstance,v)){var d=getContext(m);n.compile(h,d.instance),this.instances.push(m)}}}else{var m,y=getContext(m=this.instances[p]).node;y.parentNode.removeChild(y),n.remove(y)}this.instances.length=u.length},e.prototype.getExpressionToken=function(t){if(null===t)throw"invalid for";if(-1===t.trim().indexOf("let ")||-1===t.trim().indexOf(" of "))throw"invalid for";var e=t.split(";").map((function(t){return t.trim()})).filter((function(t){return""!==t})),n=e[0].split(" of ").map((function(t){return t.trim()})),r=n[0].replace(/\s*let\s*/,""),o=n[1],i="index",s=r.match(/\[(.+)\s*,\s*(.+)\]/);if(s&&(i=s[1],r=s[2]),e.length>1){var u=e[1].split(/\s*let\s*|\s*=\s*index/).map((function(t){return t.trim()}));3===u.length&&(i=u[1])}return{key:i,value:r,iterable:o}},e}(Structure);ForStructure.meta={selector:"[*for]"};var HrefDirective=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onChanges=function(t){getContext(this).node.setAttribute("href",this.href)},e}(Directive);HrefDirective.meta={selector:"[[href]]",inputs:["href"]};var IfStructure=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.instances=[],e}return __extends(e,t),e.prototype.onInit=function(){var t=getContext(this),e=t.module,n=t.node,r=this.ifbegin=document.createComment("*if begin");r.rxcompId=n.rxcompId,n.parentNode.replaceChild(r,n);var o=this.ifend=document.createComment("*if end");r.parentNode.insertBefore(o,r.nextSibling);var i=n.getAttribute("*if");this.ifFunction=e.makeFunction(i);var s=n.cloneNode(!0);s.removeAttribute("*if"),this.clonedNode=s,this.node=s.cloneNode(!0)},e.prototype.onChanges=function(t){var e=getContext(this).module,n=e.resolve(this.ifFunction,t,this),r=this.node;n?r.parentNode||(this.ifend.parentNode.insertBefore(r,this.ifend),e.compile(r)):r.parentNode&&(e.remove(r,this),r.parentNode.removeChild(r),this.node=this.clonedNode.cloneNode(!0))},e}(Structure);IfStructure.meta={selector:"[*if]"};var InnerHtmlDirective=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onChanges=function(t){getContext(this).node.innerHTML=null==this.innerHTML?"":this.innerHTML},e}(Directive);InnerHtmlDirective.meta={selector:"[innerHTML]",inputs:["innerHTML"]};var Pipe=function(){function t(){}return t.transform=function(t){return t},t}(),JsonPipe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.transform=function(t){return JSON.stringify(t,null,"\t")},e}(Pipe);JsonPipe.meta={name:"json"};var SrcDirective=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onChanges=function(t){getContext(this).node.setAttribute("src",this.src)},e}(Directive);SrcDirective.meta={selector:"[[src]]",inputs:["src"]};var StyleDirective=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onInit=function(){var t=getContext(this),e=t.module,n=t.node.getAttribute("[style]");this.styleFunction=e.makeFunction(n)},e.prototype.onChanges=function(t){var e=getContext(this),n=e.module,r=e.node,o=n.resolve(this.styleFunction,t,this);for(var i in o)r.style.setProperty(i,o[i])},e}(Directive);StyleDirective.meta={selector:"[[style]]"};var CoreModule=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Module),factories=[ClassDirective,EventDirective,ForStructure,HrefDirective,IfStructure,InnerHtmlDirective,SrcDirective,StyleDirective],pipes=[JsonPipe];CoreModule.meta={declarations:__spreadArrays(factories,pipes),exports:__spreadArrays(factories,pipes)};var ORDER=[Structure,Component,Directive],Platform=function(){function t(){}return t.bootstrap=function(t){var e=this.resolveMeta(t),n=e.bootstrap;if(!n)throw"missing bootstrap";var r=e.node=this.querySelector(n.meta.selector);if(!r)throw"missing node "+n.meta.selector;e.nodeInnerHTML=r.innerHTML;e.pipes=this.resolvePipes(e);var o=e.factories=this.resolveFactories(e);this.sortFactories(o),o.unshift(n);e.selectors=this.unwrapSelectors(o);var i=new t;return i.meta=e,i.compile(r,window)[0].pushChanges(),i},t.querySelector=function(t){return document.querySelector(t)},t.resolveMeta=function(t){var e=this,n=Object.assign({imports:[],declarations:[],pipes:[],exports:[]},t.meta);return n.imports=n.imports.map((function(t){return e.resolveMeta(t)})),n},t.resolvePipes=function(t,e){var n=this,r=t.imports.map((function(t){return n.resolvePipes(t,!0)})),o={};return(e?t.exports:t.declarations).filter((function(t){return t.prototype instanceof Pipe})).forEach((function(t){return o[t.meta.name]=t})),Object.assign.apply(Object,__spreadArrays([{}],r,[o]))},t.resolveFactories=function(t,e){var n,r=this,o=t.imports.map((function(t){return r.resolveFactories(t,!0)})),i=(e?t.exports:t.declarations).filter((function(t){return t.prototype instanceof Structure||t.prototype instanceof Component||t.prototype instanceof Directive}));return(n=Array.prototype.concat).call.apply(n,__spreadArrays([i],o))},t.sortFactories=function(t){t.sort((function(t,e){var n=ORDER.reduce((function(e,n,r){return t.prototype instanceof n?r:e}),-1)-ORDER.reduce((function(t,n,r){return e.prototype instanceof n?r:t}),-1);return 0===n?(t.meta.hosts?1:0)-(e.meta.hosts?1:0):n}))},t.getExpressions=function(t){var e=[];return t.replace(/\.([\w\-\_]+)|\[(.+?\]*)(\=)(.*?)\]|\[(.+?\]*)\]|([\w\-\_]+)/g,(function(t,n,r,o,i,s,u){return n&&e.push((function(t){return t.classList.contains(n)})),r&&e.push((function(t){return t.hasAttribute(r)&&t.getAttribute(r)===i||t.hasAttribute("["+r+"]")&&t.getAttribute("["+r+"]")===i})),s&&e.push((function(t){return t.hasAttribute(s)||t.hasAttribute("["+s+"]")})),u&&e.push((function(t){return t.nodeName.toLowerCase()===u.toLowerCase()})),""})),e},t.unwrapSelectors=function(t){var e=this,n=[];return t.forEach((function(t){t.meta.selector.split(",").forEach((function(r){r=r.trim();var o=[],i=r.replace(/\:not\((.+?)\)/g,(function(t,n){return o=e.getExpressions(n),""})),s=e.getExpressions(i);n.push((function(e){var n=s.reduce((function(t,n){return t&&n(e)}),!0),i=o.reduce((function(t,n){return t||n(e)}),!1);return!(!n||i)&&{node:e,factory:t,selector:r}}))}))})),n},t.isBrowser=function(){return Boolean(window)},t}(),Browser=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Platform);export{Browser,ClassDirective,Component,Context,CoreModule,Directive,EventDirective,ForItem,ForStructure,HrefDirective,IfStructure,InnerHtmlDirective,JsonPipe,Module,Pipe,Platform,SrcDirective,Structure,StyleDirective,getContext,getContextByNode,getHost};
//# sourceMappingURL=rxcomp.min.js.map