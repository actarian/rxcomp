!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("rxcomp",["exports","rxjs","rxjs/operators"],e):e((t=t||self).rxcomp={},t.rxjs,t.rxjs.operators)}(this,(function(t,e,n){"use strict";function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function o(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var i=function(){};i.meta={selector:"[(directive)]"};var s=function(){};s.meta={selector:"[component]"};var u=0,a={},c=function(){function t(e){if(!e)throw"missing options";if(!e.bootstrap)throw"missing bootstrap";this.options=e;var n={};e.pipes&&e.pipes.forEach((function(t){return n[t.meta.name]=t})),this.pipes=n;var r=e.bootstrap;if(this.node=document.querySelector(r.meta.selector),!this.node)throw"missing node "+r.meta.selector;this.root=this.makeInstance(this.node,r,r.meta.selector,window),this.selectors=t.unwrapSelectors(e.factories)}var r=t.prototype;return r.use$=function(){var r=this;return e.of(t.querySelectorsAll(this.node,this.selectors,[])).pipe(n.filter((function(t){return t.length>0})),n.map((function(t){return t.map((function(t){return r.makeInstance(t.node,t.factory,t.selector)}))})),n.shareReplay(1))},r.makeInstance=function(r,o,i,u){var a=this;if(r.parentNode){var c=o.prototype instanceof s,f=o.meta;if(!(u=u||this.getParentScope(r.parentNode)))return;var l=new o;Object.defineProperties(l,{state$:{value:new e.BehaviorSubject(l),writable:!1,enumerable:!1},unsubscribe$:{value:new e.Subject,writable:!1,enumerable:!1}}),l.pushState=function(){this.state$.next(this)};var p=t.setContext(this,l,u,r,o,i);return c&&(p.inputs=this.makeInputs(f,l),p.outputs=this.makeOutputs(f,l)),"function"==typeof l.onInit&&l.onInit(),u.state$&&u.state$.pipe(n.takeUntil(l.unsubscribe$)).subscribe((function(t){c&&a.resolveInputsOutputs(l,t),a.pushState(l,t),c&&a.parse(r,l)})),l}},r.remove=function(e){var n=[];return t.traverseDown(e,(function(t){for(var e=0,r=Object.entries(a);e<r.length;e++){var o=r[e],i=o[0],s=o[1];if(s.node===t){var u=s.instance;u.unsubscribe$.next(),u.unsubscribe$.complete(),"function"==typeof u.onDestroy&&u.onDestroy(),n.push(i)}}})),n.forEach((function(t){return delete a[t]})),e},r.compile=function(e,n){var r=this;if(n){var o=++u;n.$id=o;t.setContext(this,n,n.parentInstance,e,n.constructor)}return t.querySelectorsAll(e,this.selectors,[]).map((function(t){var e=r.makeInstance(t.node,t.factory,t.selector,n);return t.factory.prototype instanceof s&&(n=void 0),e})).filter((function(t){return void 0!==t}))},r.parse=function(t,e){for(var n=this,r=function(){var t=arguments.length<=1?void 0:arguments[1];console.log("expression",t);var r=n.makeFunction(t);return n.resolve(r,e,e)},o=function(t){return console.log(t),t.replace(/{{2}(?!{)(.*?)}{2}/g,r)},i=0;i<t.childNodes.length;i++){var s=t.childNodes[i];if(1===s.nodeType)this.parse(s,e);else if(3===s.nodeType){var u=s.nodeValue,a=o(u);if(u!==a){var c=document.createTextNode(a);t.replaceChild(c,s)}}}},r.resolve=function(t,e,n){return t.apply(e,[n,this])},r.makeInputs=function(t,e){var n=this,r={};return t.inputs&&t.inputs.forEach((function(t,o){return r[t]=n.makeInput(e,t)})),r},r.makeOutputs=function(t,e){var n=this,r={};return t.outputs&&t.outputs.forEach((function(t,o){return r[t]=n.makeOutput(e,t)})),r},r.resolveInputsOutputs=function(e,n){var r=this,o=t.getContext(e),i=o.parentInstance,s=o.inputs;Object.keys(s).forEach((function(t){var n=s[t],o=r.resolve(n,i,e);e[t]=o}))},r.getScope=function(e){return e===document?window:t.getComponentInstanceByNode(e)},r.getParentScope=function(e){var n=this;return t.traverseUp(e,(function(t){return n.getScope(t)}))},r.pushState=function(t,e){"function"==typeof t.onState&&t.onState(e),t.state$&&t.state$.next(t)},r.optionalChaining=function(t){var e;return t=t.replace(/(\w+(\?\.))+([\.|\w]+)/g,(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var o=n[0].split("?."),i=0;i<o.length-1;i++){var s=i>0?"("+o[i]+" = "+e+")":o[i],u=o[i+1];e=i>0?s+"."+u:"("+s+" ? "+s+"."+u+" : void 0)"}return e||""}))},r.makeFunction=function(e,n){if(void 0===n&&(n=["$instance"]),!e)return function(){return null};var r=this.pipes,o=t.getPipesSegments(e);return e=o.shift().trim(),e=this.optionalChaining(e),n.push("module"),o.length?(e=o.reduce((function(e,n,o){var i=t.getPipeParamsSegments(n),s=i.shift().trim(),u=r[s];if(!u||"function"!=typeof u.transform)throw"missing pipe "+s;return"pipes."+s+".transform("+e+","+i.join(",")+")"}),e),console.log("expression",e),new Function("with(this) {\n\t\t\t\treturn (function ("+n.join(",")+") {\n\t\t\t\t\tconst pipes = module.pipes;\n\t\t\t\t\treturn "+e+";\n\t\t\t\t}.bind(this)).apply(this, arguments);\n\t\t\t}")):(console.log("expression",e),new Function(this.options.debug?"with(this) {\n\t\t\t\treturn (function ("+n.join(",")+") {\n\t\t\t\t\tlet value;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvalue = "+e+";\n\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\tvalue = e.message;\n\t\t\t\t\t\t// console.error(e.message);\n\t\t\t\t\t\t// '<span style=\"color:red;\">' + e.message + ' in expression ' + expression + '</span>';\n\t\t\t\t\t}\n\t\t\t\t\treturn value;\n\t\t\t\t}.bind(this)).apply(this, arguments);\n\t\t\t}":"with(this) {\n\t\t\t\treturn (function ("+n.join(",")+") {\n\t\t\t\t\treturn "+e+";\n\t\t\t\t}.bind(this)).apply(this, arguments);\n\t\t\t}"))},r.makeInput=function(e,n){var r=t.getContext(e).node.getAttribute("["+n+"]");return this.makeFunction(r)},r.makeOutput=function(r,o){var i=this,s=t.getContext(r),u=s.node,a=s.parentInstance,c=u.getAttribute("("+o+")"),f=this.makeFunction(c,["$event"]),l=(new e.Subject).pipe(n.tap((function(t){i.resolve(f,a,t)})));return l.pipe(n.takeUntil(r.unsubscribe$)).subscribe(),r[o]=l,f},r.contexts_=function(){return a},t.getPipesSegments=function(t){for(var e=[],n=0,r="",o=0,i=t.length;n<i;){var s=t.substr(n,1);"{"!==s&&"("!==s&&"["!==s||o++,"}"!==s&&")"!==s&&"]"!==s||o--,"|"===s&&0===o?(r.length&&e.push(r),r=""):r+=s,n++}return r.length&&e.push(r),e},t.getPipeParamsSegments=function(t){for(var e=[],n=0,r="",o=0,i=t.length;n<i;){var s=t.substr(n,1);"{"!==s&&"("!==s&&"["!==s||o++,"}"!==s&&")"!==s&&"]"!==s||o--,":"===s&&0===o?(r.length&&e.push(r),r=""):r+=s,n++}return r.length&&e.push(r),e},t.unwrapSelectors=function(t){var e=[];return t.forEach((function(t){t.meta.selector.split(",").forEach((function(n){if(0===(n=n.trim()).indexOf(".")){var r=n.replace(/\./g,"");e.push((function(e){return!!e.classList.has(r)&&{node:e,factory:t,selector:n}}))}else if(n.match(/\[(.+)\]/)){var o=n.substr(1,n.length-2);e.push((function(e){return!!e.hasAttribute(o)&&{node:e,factory:t,selector:n}}))}else e.push((function(e){return!!(e.nodeName.toLowerCase()===n.toLowerCase())&&{node:e,factory:t,selector:n}}))}))})),e},t.matchSelectors=function(t,e,n){return e.forEach((function(e){var r=e(t);if(r){var o=r.factory;o.prototype instanceof s&&o.meta.template&&(t.innerHTML=o.meta.template),n.push(r)}})),n},t.querySelectorsAll=function(t,e,n){1===t.nodeType&&(n=this.matchSelectors(t,e,n));var r=t.childNodes;if(r)for(var o=0;o<r.length;o++)n=this.querySelectorsAll(r[o],e,n);return n},t.traverseUp=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);return r||this.traverseUp(t.parentNode,e,n+1)}},t.traverseDown=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);if(r)return r;if(1===t.nodeType)for(var o=0,i=t.childNodes.length;o<i&&!r;)r=this.traverseDown(t.childNodes[o],e,n+1),o++;return r}},t.traversePrevious=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);return r||this.traversePrevious(t.previousSibling,e,n+1)}},t.traverseNext=function(t,e,n){if(void 0===n&&(n=0),t){var r=e(t,n);return r||this.traverseNext(t.nextSibling,e,n+1)}},t.use$=function(e){return new t(e).use$()},t.getContext=function(t){return a[t.$id]},t.setContext=function(t,e,n,r,o,i){var s=++u;return e.$id=s,a[s]={module:t,instance:e,parentInstance:n,node:r,factory:o,selector:i}},t.getComponentInstanceByNode=function(t){var e=Object.keys(a).find((function(e){return a[e].node===t&&a[e].factory.prototype instanceof s}));if(e)return a[e].instance},t}(),f=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var n=e.prototype;return n.onInit=function(){var t=c.getContext(this),e=t.module,n=t.node.getAttribute("[class]");this.classFunction=e.makeFunction(n)},n.onState=function(t){var e=c.getContext(this),n=e.module,r=e.node,o=n.resolve(this.classFunction,t,this);Object.keys(o).forEach((function(t){o[t]?r.classList.add(t):r.classList.remove(t)}))},e}(i);f.meta={selector:"[[class]]"};var l=function(t){function r(){return t.apply(this,arguments)||this}return o(r,t),r.prototype.onInit=function(){var t=c.getContext(this),r=t.module,o=t.node,i=t.selector,s=t.parentInstance,u=this.event=i.replace(/\[|\]|\(|\)/g,""),a=this.event$=e.fromEvent(o,u).pipe(n.shareReplay(1)),f=o.getAttribute("("+u+")");if(f){var l=r.makeFunction(f,["$event"]);a.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){r.resolve(l,s,t)}))}else s[u+"$"]=a},r}(i);l.meta={selector:"[("+["click","mousedown","mouseup","touchstart","touchmove","touchend","keydown","keyup","input","change","loaded"].join(")],[(")+")]"};var p=function(){};p.meta={selector:"[(directive)]"};var h=function(t){function e(e,n,r,o,i,s,u){var a;return console.log(e,n,r,o),(a=t.call(this,u)||this)[e]=n,a[r]=o,a.index=i,a.count=s,a}var n,i,s;return o(e,t),e.prototype.pushState=function(){this.state$.next(this)},n=e,(i=[{key:"first",get:function(){return 0===this.index}},{key:"last",get:function(){return this.index===this.count-1}},{key:"even",get:function(){return this.index%2==0}},{key:"odd",get:function(){return!this.even}}])&&r(n.prototype,i),s&&r(n,s),e}((function(t,n){var r=this,o=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(t));delete o.constructor,Object.keys(o).forEach((function(e){var n=o[e];"function"==typeof n.value&&(n.value=function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];t[e].apply(t,r)})}));var i=Object.getOwnPropertyDescriptors(t);Object.keys(i).forEach((function(e){var n=i[e];"function"==typeof n.value&&(n.value=function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];t[e].apply(t,r)})})),Object.defineProperties(this,Object.assign(o,i,{state$:{value:new e.BehaviorSubject(this),writable:!1,enumerable:!1},unsubscribe$:{value:new e.Subject,writable:!1,enumerable:!1}},n)),this.pushState=function(){r.state$.next(r)}})),v=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var n=e.prototype;return n.onInit=function(){var t=c.getContext(this),e=t.module,n=t.node,r=this.forbegin=document.createComment("*for begin");n.parentNode.replaceChild(r,n);var o=this.forend=document.createComment("*for end");r.parentNode.insertBefore(o,r.nextSibling);var i=n.getAttribute("*for");n.removeAttribute("*for");var s=this.tokens=this.getExpressionTokens(i);this.forFunction=e.makeFunction(s.iterable),this.instances=[]},n.onState=function(t){for(var e=c.getContext(this),n=e.module,r=e.node,o=this.tokens,i=n.resolve(this.forFunction,t,this)||[],s=Array.isArray(i),u=s?i:Object.keys(i),a=u.length,f=this.instances.length,l=this.forbegin.nextSibling,p=0;p<Math.max(f,a);p++)if(p<a){var v=s?p:u[p],d=s?u[v]:i[v];if(p<f){var m=l,g=this.instances[p];g[o.key]=v,g[o.value]=d,g.pushState(),n.parse(m,g),l=l.nextSibling}else{var y=r.cloneNode(!0);this.forend.parentNode.insertBefore(y,this.forend);var b=new h(o.key,v,o.value,d,p,a,e.parentInstance);n.compile(y,b),n.parse(y,b),l=y.nextSibling,this.instances.push(b)}}else{var x=this.instances[p],S=c.getContext(x).node;S.parentNode.removeChild(S),n.remove(S)}this.instances.length=u.length,console.log(this.instances,o)},n.getExpressionTokens=function(t){if(null===t)throw"invalid for";if(-1===t.trim().indexOf("let ")||-1===t.trim().indexOf(" of "))throw"invalid for";var e=t.split(";").map((function(t){return t.trim()})).filter((function(t){return""!==t})),n=e[0].split(" of ").map((function(t){return t.trim()})),r=n[0].replace(/\s*let\s*/,""),o=n[1],i="index",s=r.match(/\[(.+)\s*,\s*(.+)\]/);if(s&&(i=s[1],r=s[2]),e.length>1){var u=e[1].split(/\s*let\s*|\s*=\s*index/).map((function(t){return t.trim()}));3===u.length&&(i=u[1])}return{key:i,value:r,iterable:o}},e}(p);v.meta={selector:"[*for]"};var d=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var n=e.prototype;return n.onInit=function(){var t=c.getContext(this),e=t.module,n=t.node,r=this.ifbegin=document.createComment("*if begin");n.parentNode.replaceChild(r,n);var o=this.ifend=document.createComment("*if end");r.parentNode.insertBefore(o,r.nextSibling);var i=n.getAttribute("*if");this.expression=i,this.ifFunction=e.makeFunction(i);var s=n.cloneNode(!0);s.removeAttribute("*if"),this.clonedNode=s},n.onState=function(t){var e=c.getContext(this).module;e.resolve(this.ifFunction,t,this)?this.clonedNode.parentNode||(this.ifend.parentNode.insertBefore(this.clonedNode,this.ifend),e.compile(this.clonedNode),e.parse(this.clonedNode,t)):this.clonedNode.parentNode&&(this.clonedNode.parentNode.removeChild(this.clonedNode),e.remove(this.clonedNode))},e}(p);d.meta={selector:"[*if]"};var m=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var n=e.prototype;return n.onInit=function(){var t=c.getContext(this),e=t.module,n=t.node,r=t.selector,o=n.getAttribute(r);this.innerHtmlFunction=e.makeFunction(o),console.log("InnerHtmlDirective.onInit",o,r)},n.onState=function(t){var e=c.getContext(this),n=e.module,r=(e.node,n.resolve(this.innerHtmlFunction,t,this));console.log("InnerHtmlDirective.onState",t,r)},e}(i);m.meta={selector:"[[innerHTML]],[innerHTML]"};var g=function(){function t(){}return t.transform=function(t){return JSON.stringify(t)},t}();g.meta={name:"json"};var y=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var n=e.prototype;return n.onInit=function(){var t=c.getContext(this),e=t.module,n=t.node.getAttribute("[style]");this.styleFunction=e.makeFunction(n)},n.onState=function(t){var e=c.getContext(this),n=e.module,r=e.node,o=n.resolve(this.styleFunction,t,this);Object.keys(o).forEach((function(t){r.style[t]=o[t]}))},e}(i);y.meta={selector:"[[style]]"},t.ClassDirective=f,t.Component=s,t.Directive=i,t.EventDirective=l,t.ForStructure=v,t.IfStructure=d,t.InnerHtmlDirective=m,t.JsonPipe=g,t.Module=c,t.Structure=p,t.StyleDirective=y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=rxcomp.min.js.map